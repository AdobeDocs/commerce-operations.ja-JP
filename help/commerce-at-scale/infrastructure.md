---
title: Adobe CommerceとAdobe Experience Managerのインフラストラクチャの連携
description: Adobe CommerceとAdobe Experience Managerのインフラストラクチャを揃えて、許容可能なタイムアウトと接続制限を設定します。
exl-id: f9cb818f-1461-4b23-b931-e7cee70912fd
source-git-commit: e76f101df47116f7b246f21f0fe0fa72769d2776
workflow-type: tm+mt
source-wordcount: '671'
ht-degree: 0%

---

# インフラストラクチャの整合（タイムアウトと接続の制限）

連携が必要なロードバランサーなど、AEMとAdobe Commerceおよびそれに関連するインフラストラクチャには、設定があります。これらは、接続の制限とタイムアウトの設定に関連しています。

これらの制限値の間にずれが生じると、接続がAEM側でスロットルされ、Adobe Commerceはより多くの接続を処理できます。 同様に、タイムアウト設定では、ずれが生じると、Adobe Commerceが引き続きリクエストを処理している間にAEM側でタイムアウトエラーが発生する可能性があります。

タイムアウトの設定については、設定を確認し、整列して、負荷時に 503 タイムアウトエラーが表示されないようにする必要があります。 確認するインフラストラクチャおよびアプリケーションのタイムアウト設定はいくつかあります。

![AEMのタイムアウトと接続制限を説明する番号付きの図](../assets/commerce-at-scale/timeout-settings.svg)

## AEMロードバランサー

インフラストラクチャにAWSアプリケーションロードバランサーがあり、複数の Dispatchers/Publishers がある場合は、ロードバランサーに対して次の設定を考慮する必要があります。

1. パブリッシャーのヘルスチェックは、不必要に早くサービスを停止したディスパッチャーが負荷の急増を起こすのを防ぐために、確認する必要があります。 ロードバランサーのヘルスチェックのタイムアウト設定は、パブリッシャーのタイムアウト設定と一致させる必要があります。

   ![AEMロードバランサーのヘルスチェックを示すスクリーンショット](../assets/commerce-at-scale/health-checks.png)

1. Dispatcher ターゲットグループのスティッキネスを無効にしたり、ラウンドロビンロードバランシングアルゴリズムを使用したりできます。 これは、セッション定着度の設定が必要なAEM固有の機能やAEMユーザーセッションがないと仮定しています。 ここでは、ユーザーログインとセッション管理が、GraphQL経由でのAdobe Commerce上にのみ存在することを前提としています。

   ![AEMセッションのスティッキー属性を示したスクリーンショット](../assets/commerce-at-scale/session-stickiness.png)

1. セッションの定着を有効にした場合、Fastly へのリクエストがキャッシュされない可能性があります。これは、デフォルトでは Fastly が Set-Cookies ヘッダーを持つページをキャッシュしないためです。 Adobe Commerceはキャッシュ可能なページ (TTL > 0) でも cookie を設定しますが、デフォルトの Fastly VCL では、Fastly キャッシュが機能するように、キャッシュ可能なページでは cookie を削除します。 ページがキャッシュされていない場合は、使用しているカスタム cookie を確認し、Fastly VCL もアップロードして、サイトを再確認してください。

## Dispatcher のタイムアウト設定

Dispatcher の「renders」オプションの/timeout は、AEMパブリッシュインスタンスにアクセスする接続タイムアウトをミリ秒単位で指定します。 これを確認し、タイムアウト設定を処理する別のロードバランサーが存在する場合は、デフォルト設定の「0」（無期限のタイムアウト）を使用する必要があります。

インフラストラクチャにロードバランサーがない場合は、代わりに dispatcher /timeout 設定でタイムアウト設定を指定し、パブリッシャーのGraphQLタイムアウト設定と一致する値を指定する必要があります。

## 発行者

パブリッシャーGraphQL接続の制限とタイムアウト：最初に、Adobe Commerce CIF GraphQL Client Configuration Factory OSGi 設定の最大 HTTP 接続数を、デフォルトの最大接続数制限（現在は 200 に設定）に設定する必要があります。 AEMファームに複数の発行者が存在する場合でも、各発行者で制限を同じに設定し、Fastly 設定に一致させる必要があります。 これが原因は、関連付けられた Dispatcher がファームから取り出された場合など、場合によっては、1 つのパブリッシャーが他のパブリッシャーよりも多くのトラフィックを処理する可能性があるからです。 つまり、残りの 1 つの Dispatcher およびパブリッシャーを通じてすべてのトラフィックがルーティングされます。この場合、1 つのパブリッシャーがすべての HTTP 接続を必要とする可能性があります。

「デフォルトの HTTP メソッド」は、「POST」から「GET」に設定する必要があります。 GETリクエストのみがAdobe Commerce GraphQLのキャッシュにキャッシュされるので、デフォルトの方法は常にGETに設定する必要があります。

http 接続タイムアウトと http ソケットタイムアウトは、Fastly タイムアウトと一致する値に設定する必要があります。

次の画像は、CIF GraphQL Client Configuration FactoryMagentoを示しています。 以下に示す設定は例に過ぎません。また、ケースバイケースで調整する必要があります。

![コマース統合フレームワーク構成設定のスクリーンショット](../assets/commerce-at-scale/cif-config.png)

以下の画像は、Fastly のバックエンド設定を示しています。 以下に示す設定は例に過ぎません。また、ケースバイケースで調整する必要があります。

![Fastly のコマース管理者構成設定のスクリーンショット](../assets/commerce-at-scale/cif-config-advanced.png)
