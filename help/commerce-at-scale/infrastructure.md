---
title: AdobeコマースとAdobe Experience Managerインフラストラクチャの連携
description: AdobeのコマースとAdobe Experience Managerインフラストラクチャを調整して、許容可能なタイムアウトと接続制限を設定します。
exl-id: f9cb818f-1461-4b23-b931-e7cee70912fd
source-git-commit: e76f101df47116f7b246f21f0fe0fa72769d2776
workflow-type: tm+mt
source-wordcount: '671'
ht-degree: 0%

---

# インフラストラクチャの整合（タイムアウトと接続の制限）

連携が必要なロードバランサーなど、AEMとAdobeコマースおよび周辺のインフラストラクチャには、接続の制限とタイムアウトの設定に関連する設定があります。

これらの制限間のずれは、接続がAEM側で調整され、Adobeコマースはより多くの接続を処理できる一方で、接続が調整される可能性があることを意味します。 同様に、タイムアウト設定では、ずれが発生すると、AEM側でタイムアウトエラーが発生し、AdobeCommerce がまだ要求を処理している間に発生する可能性があります。

タイムアウト設定の場合は、負荷時に 503 のタイムアウトエラーが表示されないように、設定を確認して整列する必要があります。 確認するインフラストラクチャとアプリケーションのタイムアウト設定はいくつかあります。

![AEMのタイムアウトと接続制限を説明する番号付き図](../assets/commerce-at-scale/timeout-settings.svg)

## AEMロードバランサー

インフラストラクチャに AWS アプリケーションのロードバランサーがあり、複数の Dispatcher/パブリッシャーがあると仮定します。ロードバランサーについては、次の設定を考慮する必要があります。

1. パブリッシャーのヘルスチェックを確認して、不必要に早期にサービスを停止したディスパッチャーが負荷の急増を防ぐ必要があります。 ロードバランサーのヘルスチェックのタイムアウト設定は、パブリッシャーのタイムアウト設定と一致する必要があります。

   ![AEMロードバランサーのヘルスチェックを示すスクリーンショット](../assets/commerce-at-scale/health-checks.png)

1. Dispatcher のターゲットグループのスティッキネスを無効にしたり、ラウンドロビンロードバランシングアルゴリズムを使用したりできます。 これは、セッションの定着度を設定する必要があるAEM固有の機能やAEMユーザーセッションがないと仮定しています。 ユーザーログインとセッション管理は、GraphQL を介したAdobeコマースでのみおこなわれることを前提としています。

   ![AEMセッションの定着度属性を示すスクリーンショット](../assets/commerce-at-scale/session-stickiness.png)

1. セッションの定着度を有効にした場合、Fastly に対する要求がキャッシュされない可能性があります。デフォルトでは、Fastly は Set-Cookies ヘッダーを含むページをキャッシュしません。 Adobeコマースはキャッシュ可能なページ (TTL > 0) でも cookie を設定しますが、デフォルトの Fastly VCL では、Fastly キャッシュが機能するように、キャッシュ可能なページでこれらの cookie を削除します。 ページがキャッシュされていない場合は、使用しているカスタム cookie を確認し、Fastly VCL もアップロードしてサイトを再確認してください。

## Dispatcher のタイムアウト設定

Dispatcher の「renders」オプションの/timeout は、AEMパブリッシュインスタンスにアクセスする接続タイムアウトをミリ秒単位で指定します。 これを確認し、タイムアウト設定を処理する別のロードバランサーが存在する場合は、デフォルト設定の「0」（無期限のタイムアウト）を使用する必要があります。

インフラストラクチャにロードバランサーがない場合は、代わりに dispatcher /timeout 設定でタイムアウト設定を指定し、パブリッシャーの GraphQL タイムアウト設定と一致する値を指定する必要があります。

## 発行者

パブリッシャー GraphQL 接続の制限とタイムアウト：最初は、Adobeコマース CIF GraphQL クライアント設定ファクトリの OSGI 設定の最大 HTTP 接続数を、デフォルトの最大接続数制限（現在は 200 に設定）に設定する必要があります。 AEMファームに複数の発行者が存在する場合でも、各発行者で制限を同じに設定し、Fastly 設定に合わせる必要があります。 この理由は、関連する Dispatcher がファームから取り出された場合など、場合によっては、1 つのパブリッシャーが他のパブリッシャーより多くのトラフィックを処理する可能性があるからです。 これは、残りの 1 つの Dispatcher およびパブリッシャーを通じてすべてのトラフィックがルーティングされることを意味します。この場合、単一のパブリッシャーがすべての HTTP 接続を必要とする可能性があります。

「デフォルトの HTTP メソッド」は、「POST」から「GET」に設定する必要があります。 GETリクエストのみがAdobeコマース GraphQL キャッシュにキャッシュされるので、デフォルトのメソッドは常にGETに設定する必要があります。

http 接続タイムアウトと http ソケットタイムアウトは、Fastly タイムアウトと一致する値に設定する必要があります。

次の画像は、CIF GraphQL Client Configuration FactoryMagentoを示しています。 ここに示す設定は例のみで、ケースバイケースで調整する必要があります。

![コマース統合フレームワークの構成設定のスクリーンショット](../assets/commerce-at-scale/cif-config.png)

次の画像は、Fastly のバックエンド設定を示しています。 ここに示す設定は例のみで、ケースバイケースで調整する必要があります。

![Fastly のコマース管理者の構成設定のスクリーンショット](../assets/commerce-at-scale/cif-config-advanced.png)
