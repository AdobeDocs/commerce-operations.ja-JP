---
title: Adobe Commerce Performance Optimization
description: 一部のデフォルト設定を変更して、Adobe Experience Managerを CMS として使用するようにAdobe Commerceプロジェクトを準備します。
exl-id: 55d77af7-508c-4ef7-888b-00911cc6e920
feature: Integration, Cache
topic: Commerce, Performance
source-git-commit: 76ccc5aa8e5e3358dc52a88222fd0da7c4eb9ccb
workflow-type: tm+mt
source-wordcount: '1143'
ht-degree: 0%

---

# Adobe Commerce Performance Optimization

## AEMおよびAdobe Commerceインフラストラクチャの地理的な場所

ページの構築時にAEMパブリッシャーとAdobe Commerce GraphQLの間の待ち時間を短縮するには、2 つの異なるインフラストラクチャの初期プロビジョニングを同じAWS（または Azure）地域内でホストする必要があります。 また、クライアント側のGraphQLリクエストが地理的に近い場所から大多数のお客様に提供されるように、両方のクラウド用に選択した地理的な場所を顧客ベースの大部分に最も近くする必要があります。

## Adobe CommerceでのGraphQLキャッシュ

ユーザーのブラウザーまたはAEMの投稿者がAdobe Commerceを呼び出すと、特定の呼び出しが Fastly にキャッシュされます。 キャッシュされるクエリは、通常、個人データ以外のデータを含むクエリであり、頻繁に変更される可能性が低いクエリです。 次に例を示します。categories、categoryList および products。 明示的にキャッシュされないものは、定期的に変更されるもので、キャッシュされた場合は、買い物かごや customerPaymentTokens などのクエリなど、個人データやサイトの操作にリスクが生じる可能性があります。

GraphQLでは、1 回の呼び出しで複数のクエリを実行できます。 1 つのクエリも指定し、Adobe Commerceがキャッシュできない他の多数のクエリをキャッシュしない場合、Adobe Commerceは呼び出しで使用されるすべてのクエリのキャッシュをバイパスすることに注意する必要があります。 これは、複数のクエリを組み合わせる際に開発者が考慮する必要があります。これにより、キャッシュ可能な可能性のあるクエリが意図せず‡を迂回してしまうのを防ぐことができます。

>[!NOTE]
>
> キャッシュ可能なクエリとキャッシュ不可能なクエリについて詳しくは、 Adobe Commerce [開発者向けドキュメント](https://devdocs.magento.com/guides/v2.4/graphql/caching.html).

## カタログフラットテーブル

製品やカテゴリに対してフラットテーブルを使用することはお勧めしません。 この廃止された機能を使用すると、パフォーマンスが低下し、インデックス作成の問題が発生する可能性があるので、ストアフロントセクションのAdobe Commerce管理者でフラットカタログを無効にする必要があります。 一部のサードパーティモジュールやカスタマイズ機能を正しく機能させるには、フラットテーブルが必要です。フラットテーブルを使用する場合の影響やリスクを把握するために、評価を行うことをお勧めします。

## Fastly 接触チャネルシールド

既定では、Fastly 接触チャネルシールドは無効になっています。 Fastly の接触チャネルシールドの目的は、Adobe Commerceの接触チャネルへの直接のトラフィックを減らすことです。リクエストを受け取ると、Fastly エッジの場所（または「point of presence」/POP）はキャッシュされたコンテンツを確認し、提供します。 キャッシュされていない場合は、Shield POP が引き続きそこでキャッシュされているかどうかを確認します（他のグローバル POP からも以前にコンテンツが要求されている場合は、キャッシュされます）。 最後に、Shield POP 上でキャッシュされていない場合は、Origin サーバに進みます。

正確な接触チャネルシールドは、Adobe Commerce管理者 Fastly 設定バックエンド設定で有効にできます。 最高のパフォーマンスを得るには、Adobe Commerceの元のデータセンターに最も近いシールドの場所を選択する必要があります。

## 画像の最適化

Fastly オリジンシールドが有効になると、Fastly Image Optimizer も有効になります。 製品カタログ画像がAdobe Commerceに保存される場合、このサービスを使用すると、リソースを集中的に消費する製品カタログ画像の変換処理をすべて Fastly にオフロードし、Adobe Commerceの起源から離れることができます。 また、画像はエッジの場所で変換されるので、Adobe Commerce接触チャネルに戻るリクエスト数を減らすことで待ち時間をなくすので、ページ読み込み時間に対するエンドユーザーの応答時間も短縮されます。

Fastly 画像の最適化は、オリジンシールドが有効化された後にのみ、管理の Fastly 設定で「ディープ画像の最適化を有効にする」ことで有効にできます。 Fastly 画像の最適化の設定について詳しくは、Adobe Commerceを参照してください。 [開発者向けドキュメント](https://devdocs.magento.com/cloud/cdn/fastly-image-optimization.html).

![Adobe Commerce Admin での Fastly 画像最適化設定のスクリーンショット](../assets/commerce-at-scale/image-optimization.svg)

## 未使用のモジュールを無効にする

Adobe Commerceヘッドレスを実行し、GraphQLエンドポイント経由でのみリクエストを提供し、フロントエンドストアページをAdobe Commerceから直接提供しない場合、多くのモジュールが冗長化され、使用されなくなります。 未使用のモジュールを無効にすると、Adobe Commerceのコードベースが小さくなり、複雑さが少なくなるので、パフォーマンスが向上します。 Adobe Commerceでのモジュールの無効化は、composer を使用して管理できます。 無効にできるモジュールは、サイトの要件に応じて異なるので、各お客様のAdobe Commerceの実装に固有な推奨リストは提供できません。

## MySQL と Redis の接続の有効化

デフォルトでは、MySQL と Redis Slave の接続はクラウド上のAdobe Commerceではアクティブ化されません。 これは、これらの設定が、非常に高い負荷を予想するお客様にのみ適しているためです。 クロス AZ（クロスアベイラビリティゾーン）の待ち時間は、スレーブ接続が有効になっている場合は高くなるので、この設定は、インスタンスが通常の負荷レベルのみを受け取る場合に、クラウドインスタンス上のAdobe Commerceのパフォーマンスを実際に低下させます。

Adobe Commerceインスタンスが極端な負荷を期待している場合は、MySQL と Redis のマスタースレーブをアクティブ化すると、MySQL データベースまたは Redis の負荷を異なるノードに分散させてパフォーマンスを向上できます。

ガイドとして、通常の負荷の環境では、スレーブ接続を有効にすると、パフォーマンスが 10～15%低下します。 しかし、負荷とトラフィックが大きいクラスタでは、パフォーマンスが約 10～15%向上します。 したがって、期待されるトラフィックレベルで環境をロードテストし、負荷時のパフォーマンス時間にこの設定が役立つかどうかを評価することが重要です。

mysql と redis のスレーブ接続を有効/無効にするには、 `.magento.env.yaml` ファイルに次の情報を含めます。

```
stage:
  deploy:
    MYSQL_USE_SLAVE_CONNECTION: true
    REDIS_USE_SLAVE_CONNECTION: true
```

スケールアーキテクチャ（分割アーキテクチャ — 以下を参照）の場合、Redis スレーブ接続を有効にしないでください。有効にすると、エラーが発生します。 分割アーキテクチャの場合は、代わりに Redis 用の L2 キャッシュを実装することをお勧めします。

## クラウド拡張（分割）アーキテクチャ上のAdobe Commerceへの移行

上記のすべての設定の後、負荷テストの結果またはライブインフラストラクチャのパフォーマンスの分析が、Adobe Commerceの負荷レベルが CPU や他のシステムリソースを一貫して最大限にするレベルであることを示している場合は、拡張（分割）アーキテクチャへの移行を考慮する必要があります。

標準の Pro アーキテクチャでは、3 つのノードがあり、それぞれに完全なテクニカルスタックが含まれています。 を分割層アーキテクチャに変換すると、次の変更が少なくとも 6 ノードになります。そのうち 3 つは、Elasticsearch、マリア DB、レディス、その他のコアサービスを含んでいます。ウェブトラフィックを処理する他の 3 は phpfpm と NGINX を含む。 分割層には、より大きな拡張性があります。データベースを含むコアノードは垂直方向に拡大・縮小できます。web ノードは、水平および垂直に拡張できるので、高負荷アクティビティの設定期間に対して、インフラストラクチャをオンデマンドで拡張する柔軟性が大きく、追加のリソースが必要なノード上でも大幅に高くなります。

サイトへの負荷が大きく、分割層アーキテクチャに切り替える決定がなされた場合は、これを有効にする手順について、Adobeのアカウントチームとディスカッションを行う必要があります。
