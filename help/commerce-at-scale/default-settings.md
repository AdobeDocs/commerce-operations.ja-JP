---
title: Adobe Commerceのパフォーマンスの最適化
description: デフォルト設定を変更して、Adobe Experience Manager as a CMSを使用するようにAdobe Commerce プロジェクトを準備します。
exl-id: 55d77af7-508c-4ef7-888b-00911cc6e920
feature: Integration, Cache
topic: Commerce, Performance
source-git-commit: 987d65b52437fbd21f41600bb5741b3cc43d01f3
workflow-type: tm+mt
source-wordcount: '1142'
ht-degree: 0%

---

# Adobe Commerceのパフォーマンスの最適化

## AEMおよびAdobe Commerce インフラストラクチャの地理的な場所

ページの構築時にAEM パブリッシャーとAdobe Commerce GraphQLの間の待ち時間を短縮するには、2 つの異なるインフラストラクチャの初期プロビジョニングを同じAWS（または Azure）リージョン内でホストする必要があります。 両方のクラウド用に選択された地理的な場所は、カスタマーベースに最も近い場所である必要もあります。これにより、クライアントサイドのGraphQL リクエストは、地理的に近い場所から、ほとんどのお客様に提供されます。

## Adobe CommerceのGraphQL キャッシュ

ユーザーのブラウザーまたはAEM パブリッシャーがGraphQLをAdobe Commerceしてを呼び出すと、特定の呼び出しがキャッシュされます
Fastly で。 キャッシュされるクエリは、通常、非個人データが含まれ、頻繁に変更される可能性が低いクエリです。 例えば、categories、categoryList、products などです。 明示的にキャッシュされないプロパティは、定期的に変更されるプロパティであり、キャッシュされた場合は個人データやサイト操作（買い物かごや customerPaymentTokens などのクエリなど）にリスクが生じる可能性があります。

GraphQLでは、1 回の呼び出しで複数のクエリを実行できます。 Adobe Commerceがキャッシュしないクエリを 1 つだけ指定し、その他のキャッシュ可能でない多くのクエリを指定した場合、Adobe Commerceは、呼び出しですべてのクエリのキャッシュをバイパスすることに注意してください。 キャッシュ可能な可能性のあるクエリが意図せずにバイパスされないようにするために、複数のクエリを組み合わせる場合は、開発者がこの点を考慮する必要があります‡

>[!NOTE]
>
> キャッシュ可能なクエリとキャッシュ不可クエリについて詳しくは、Adobe Commerce[ 開発者向けドキュメント ](https://developer.adobe.com/commerce/webapi/graphql/caching.html) を参照してください。

## カタログ フラット テーブル

製品およびカテゴリに対してフラットなテーブルを使用することはお勧めしません。 この非推奨（廃止予定）の機能を使用すると、パフォーマンスが低下し、インデックスに関する問題が発生する可能性があるので、Adobe Commerce管理者のストアフロントセクションでフラットカタログを無効にする必要があります。 一部のサードパーティモジュールおよびカスタマイズでは、正しく機能するためにフラットテーブルが必要です。これらの拡張機能やカスタマイズの利用を選択する際に、フラットテーブルを使用する必要がある場合の影響とリスクを理解するために、評価を行うことをお勧めします。

## Fastly 原点シールド

デフォルトでは、Fastly オリジンシールドは有効になっていません。 Fastly のオリジンシールドの目的は、Adobe Commerce オリジンへの直接トラフィックを減らすことです。リクエストを受信すると、Fastly エッジロケーション（または「Point of Presence」/POP）がキャッシュされたコンテンツをチェックし、提供します。 キャッシュされていない場合、コンテンツは引き続き Shield POP にキャッシュされているかどうかを確認します（以前に別のグローバル POP からもリクエストされている場合、コンテンツはキャッシュされます）。 最後に、Shield POP でキャッシュされていない場合は、オリジンサーバーに進みます。

Fastly オリジンシールドは、Adobe Commerce管理者の Fastly 設定バックエンド設定で有効にできます。 最高のパフォーマンスを得るには、Adobe Commerce オリジンデータセンターに最も近いシールドの場所を選択する必要があります。

## Fastly 画像の最適化

Fastly オリジンシールドを有効にすると、Fastly Image Optimizer もアクティブになります。 商品カタログ画像がAdobe Commerceに保存されている場合、このサービスを利用すれば、リソースを集中的に消費する商品カタログ画像の変換処理をすべて、Fastly にオフロードしたり、Adobe Commerce オリジンからオフロードしたりできます。 また、画像がエッジロケーションで変換され、Adobe Commerce オリジンに戻るリクエストの数を減らすことで待ち時間をなくすことで、ページの読み込み時間についても、エンドユーザーの応答時間が改善されます。

Fastly の画像の最適化は、オリジンシールドが有効化された後に限り、管理の Fastly 設定で「ディープイメージの最適化を有効化」することで有効化できます。 Fastly での画像の最適化の設定について詳しくは、Adobe Commerce [ 開発者向けドキュメント ](https://experienceleague.adobe.com/en/docs/commerce-cloud-service/user-guide/cdn/fastly-image-optimization) を参照してください。

![Adobe Commerce Admin での Fastly 画像最適化設定のスクリーンショット ](../assets/commerce-at-scale/image-optimization.svg)

## 未使用のモジュールを無効にする

Adobe Commerce ヘッドレスを実行していて、GraphQL エンドポイントを通じてリクエストを提供するだけでは、フロントエンドストアページがAdobe Commerceから直接提供されない場合、多くのモジュールが冗長になり、使用されません。 未使用のモジュールを無効にすることで、Adobe Commerce コードベースが小さくなり、複雑さが軽減されるので、パフォーマンスが向上する可能性があります。 Adobe Commerceでのモジュールの無効化は、composer を使用して管理できます。 無効にできるモジュールは、サイトの要件によって異なります。そのため、推奨リストは、お客様のAdobe Commerceの実装に固有のものなので、提供できません。

## MySQL と Redis 接続のアクティベーション

デフォルトでは、MySQL および Redis スレーブ接続は、Cloud 上のAdobe Commerceではアクティブ化されません。 これは、これらの設定が、非常に高い負荷を期待しているお客様にのみ適しているためです。 スレーブ接続をアクティブ化すると、クロス AZ （クロス可用性ゾーン）の待ち時間が長くなるので、インスタンスが通常の負荷レベルのみを受け取っている場合、この設定は実際にクラウドインスタンス上のAdobe Commerceのパフォーマンスを低下させます。

Adobe Commerce インスタンスで極端な負荷が予想される場合は、MySQL と Redis のマスタースレーブをアクティブ化すると、MySQL Database または Redis の負荷を異なるノードに分散させることで、パフォーマンスの向上に役立ちます。

参考までに、通常の負荷がかかる環境では、スレーブ接続を有効にするとパフォーマンスが 10～15% 低下します。 しかし、負荷が高くトラフィックが多いクラスターでは、パフォーマンスが約 10～15% 向上します。 したがって、この設定が負荷状態のパフォーマンス時間にとって有益かどうかを評価するには、予想されるトラフィックレベルで環境を負荷テストすることが重要です。

mysql と redis のスレーブ接続を有効/無効にするには、`.magento.env.yaml` ファイルを編集して以下を含める必要があります。

```
stage:
  deploy:
    MYSQL_USE_SLAVE_CONNECTION: true
    REDIS_USE_SLAVE_CONNECTION: true
```

スケールされたアーキテクチャ（分割アーキテクチャ – 以下を参照）の場合、Redis スレーブ接続は有効にしないでください。これによりエラーが表示されます。 分割アーキテクチャの場合は、Redis の L2 キャッシュを実装することをお勧めします。

## Adobe Commerce on cloud 拡張（分割）アーキテクチャへの移行

上記のすべての設定を行った後も、負荷テストの結果または実稼働インフラストラクチャのパフォーマンス分析から、Adobe Commerceの負荷レベルが CPU およびその他のシステムリソースを常に限界まで押し上げるレベルであることが判明した場合は、拡張（分割）アーキテクチャへの移行を考慮する必要があります。

標準の Pro アーキテクチャでは、3 つのノードがあり、それぞれにフルテクニカルスタックが含まれています。 分割層アーキテクチャに変換すると、この変更は少なくとも 6 つのノードに反映されます。そのうち 3 つはElasticsearch、MariaDB、Redis およびその他のコアサービスを含み、他の 3 つは Web トラフィックを処理するための phpfpm および NGINX を含みます。 分割層ではスケーリングの可能性が高くなります。データベースを含むコアノードは垂直方向にスケーリングできます。web ノードは水平方向と垂直方向にスケーリングできるので、負荷の高いアクティビティの設定期間や追加リソースが必要なノードに応じて、インフラストラクチャを大幅に拡張できる柔軟性があります。

サイトの負荷が高いために分割層アーキテクチャに切り替えることを決定した場合は、これを有効にする手順についてAdobeアカウントチームと話し合う必要があります。
