---
title: Adobeコマースパフォーマンスの最適化
description: Adobe Experience Managerを CMS として使用するように、Adobeコマースプロジェクトを準備するには、いくつかのデフォルト設定を変更します。
exl-id: 55d77af7-508c-4ef7-888b-00911cc6e920
source-git-commit: e76f101df47116f7b246f21f0fe0fa72769d2776
workflow-type: tm+mt
source-wordcount: '1143'
ht-degree: 0%

---

# Adobeコマースのパフォーマンスの最適化

## AEMおよびAdobeコマースインフラストラクチャの地理的な場所

ページの構築時にAEMパブリッシャーとAdobeコマース GraphQL の間の遅延を減らすには、2 つの異なるインフラストラクチャの初期プロビジョニングを同じ AWS（または Azure）リージョン内でホストする必要があります。 また、両方のクラウドに対して選択した地理的な場所は、顧客の大部分に最も近い場所である必要があります。そのため、クライアント側の GraphQL 要求は、地理的に近い場所から顧客の大部分に提供されます。

## Adobeコマースの GraphQL キャッシュ

ユーザーのブラウザーまたはAEMパブリッシャーがAdobeコマースの GraphQL を呼び出すと、特定の呼び出しがキャッシュされます
精霊の中に キャッシュされるクエリは、通常、個人以外のデータを含み、頻繁に変更されないクエリです。 次に例を示します。categories、categoryList および products。 明示的にキャッシュされないものは、定期的に変更され、キャッシュされると、買い物かごや customerPaymentTokens などのクエリなどの個人データやサイトの操作にリスクが生じる可能性があります。

GraphQL では、1 回の呼び出しで複数のクエリを作成できます。 1 つのクエリでも、Adobeコマースがキャッシュできない他の多数のクエリをキャッシュしないように指定する場合、Adobeコマースは呼び出しのすべてのクエリのキャッシュをバイパスします。 これは、複数のクエリを組み合わせる場合に開発者が考慮する必要があります。これにより、キャッシュ可能なクエリが意図せず迂回されない可能性がある‡。

>[!NOTE]
>
> キャッシュ可能なクエリとキャッシュ不可なクエリについて詳しくは、Adobeコマース [ 開発者向けドキュメント ](https://devdocs.magento.com/guides/v2.4/graphql/caching.html) を参照してください。

## カタログフラットテーブル

製品やカテゴリに対しては、フラットテーブルを使用しないことをお勧めします。 この非推奨（廃止予定）の機能を使用すると、パフォーマンスの低下やインデックス作成の問題が発生する可能性があるので、ストアフロントセクションのAdobeコマース管理でフラットカタログを無効にする必要があります。 サードパーティのモジュールやカスタマイズの中には、フラットテーブルが正しく機能する必要があるものもあります。フラットテーブルの使用に伴う影響やリスクを理解するには、評価を行うことをお勧めします。

## ファストリ原点遮蔽

既定では、Fastly 接触チャネルシールドは有効になっていません。 Fastly のオリジンシールドの目的は、Adobe商取引所への直接のトラフィックを減らすことです。リクエストを受け取ると、Fastly エッジの場所（または「Point of Presence」/POP）はキャッシュされたコンテンツを確認し、提供します。 キャッシュされない場合は、引き続きシールド POP がそこにキャッシュされているかどうかを確認します（以前に他のグローバル POP からコンテンツが要求された場合は、キャッシュされます）。 最後に、Shield POP 上でキャッシュされていない場合は、Origin サーバに進みます。

Fastly オリジンシールドは、AdobeCommerce 管理 Fastly 設定バックエンド設定で有効にできます。 最高のパフォーマンスを得るには、Adobeコマース元のデータセンターに最も近いシールドの場所を選択する必要があります。

## 画像の最適化

Fastly オリジンシールドを有効にすると、Fastly Image Optimizer も有効にできます。 このサービスは、Adobeコマースに製品カタログ画像を格納する場合、リソースを集中的に消費するすべての製品カタログ画像変換処理を Fastly にオフロードし、Adobeコマースのオリジンからオフロードできます。 また、エッジの場所で画像が変換され、Adobeコマース元に戻る要求の数を減らすことで待ち時間をなくすので、ページ読み込み時間に対するエンドユーザーの応答時間も改善されます。

Fastly 画像の最適化は、Fastly 設定の「Enable deep image optimization」で有効にできますが、オリジンシールドが有効になった後にのみ有効です。 Fastly 画像の最適化の設定について詳しくは、Adobeコマースの [ 開発者向けドキュメント ](https://devdocs.magento.com/cloud/cdn/fastly-image-optimization.html) を参照してください。

![コマース管理での Fastly 画像の最適化設定のスクリーンショットAdobe](../assets/commerce-at-scale/image-optimization.svg)

## 未使用のモジュールの無効化

Adobeコマースヘッドレスを実行している場合、GraphQL エンドポイントを介した要求のみを提供し、Adobeコマースからフロントエンドストアページは直接提供されないので、多くのモジュールが冗長化されて使用されなくなります。 未使用のモジュールを無効にすると、Adobeのコマースコードベースが小さくなり、複雑さが少なくなり、パフォーマンスが向上します。 モジュールコマースでのAdobeの無効化は、composer を使用して管理できます。 無効にできるモジュールはサイトの要件によって異なります。したがって、各顧客のAdobeコマースの実装に固有の推奨リストは提供されません。

## MySQL と Redis の接続の有効化

デフォルトでは、MySQL と Redis Slave の接続はクラウド上のAdobeコマースではアクティブ化されません。 これは、これらの設定が非常に高い負荷を予想するお客様にのみ適しているためです。 スレーブ接続が有効になっている場合は、クロス AZ（クロスアベイラビリティゾーン）の待ち時間が長くなるので、この設定は、通常の負荷レベルしか受け取らない場合に、クラウドインスタンス上のAdobeコマースのパフォーマンスを実際に低下させます。

Adobeコマースインスタンスが極端な負荷を予想している場合は、MySQL と Redis のマスタースレーブをアクティブにすると、MySQL データベースの負荷を分散し、異なるノード間で Redis の負荷を分散してパフォーマンスが向上します。

ガイドとして、通常の負荷を持つ環境では、スレーブ接続を有効にすると、パフォーマンスが 10～15 %低下します。 しかし、負荷が大きくトラフィックが多いクラスタでは、パフォーマンスが約 10 ～ 15%向上します。 したがって、予想されるトラフィックレベルで環境をロードテストし、負荷時のパフォーマンスにこの設定が役立つかどうかを評価することが重要です。

mysql と red のスレーブ接続を有効/無効にするには、`.magento.env.yaml` ファイルを編集して次の情報を含める必要があります。

```
stage:
  deploy:
    MYSQL_USE_SLAVE_CONNECTION: true
    REDIS_USE_SLAVE_CONNECTION: true
```

スケールアーキテクチャ（分割アーキテクチャ — 以下を参照）の場合、Redis スレーブ接続は有効にしないでください。これは、エラーが発生する原因となります。 分割アーキテクチャの場合は、代わりに Redis 用の L2 キャッシュを実装することをお勧めします。

## クラウド規模（分割）アーキテクチャでのAdobeコマースへの移行

上記のすべての設定の後、負荷テストの結果またはライブインフラストラクチャのパフォーマンスの分析が、Adobeコマースの負荷レベルが、CPU や他のシステムリソースを常に最大限に引き出すレベルである場合は、スケール（分割）アーキテクチャへの移行を検討する必要があります。

標準の Pro アーキテクチャでは、3 つのノードがあり、各ノードには完全なテクニカルスタックが含まれます。 分割層アーキテクチャに変換すると、次の変更が 6 ノード以上になります。そのうち 3 つは、Elasticsearch、マリア DB、レディス、その他のコアサービスを含んでいる。web トラフィックを処理する他の 3 は、phpfpm と NGINX を含む。 分割層を使用すると、より大きな拡張性を実現できます。データベースを含むコアノードは、垂直方向にスケーリングできます。web ノードは、水平および垂直方向に拡大でき、高負荷アクティビティの設定期間に対して、インフラストラクチャをオンデマンドで拡張する柔軟性が大きく、追加のリソースが必要なノード上でも大幅に高くなります。

サイトへの負荷が大きいことが原因で、分割層アーキテクチャに切り替える決定が下された場合は、これを有効にする手順について、カスタマーサクセスマネージャーにディスカッションを行う必要があります。
