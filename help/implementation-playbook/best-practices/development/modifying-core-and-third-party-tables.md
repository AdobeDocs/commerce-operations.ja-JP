---
title: データベーステーブルを変更する際のベストプラクティス
description: Adobe Commerceとサードパーティのデータベーステーブルを変更する方法とタイミングについて説明します。
role: Developer, Architect
feature: Best Practices
last-substantial-update: 2022-11-15T00:00:00Z
exl-id: 9e7adaaa-b165-4293-aa98-5dc4b8c23022
source-git-commit: ddf988826c29b4ebf054a4d4fb5f4c285662ef4e
workflow-type: tm+mt
source-wordcount: '1405'
ht-degree: 0%

---

# データベーステーブルを変更する際のベストプラクティス

この記事では、で作成されるデータベーステーブルを変更するためのベストプラクティスを示します。 [!DNL Adobe Commerce] またはサードパーティのモジュールです。 テーブルを効果的に変更するタイミングと方法を理解することで、コマースプラットフォームの長期的な実行可能性と安定性を確保できます。

からの移行 [!DNL Magento 1] とその他の e コマースプラットフォーム、またはのモジュールの操作 [!DNL Adobe Commerce] マーケットプレイスでは、追加データの追加と保存が必要になる場合があります。 最初の例として、データベース テーブルにカラムを追加したり、既存のカラムを調整したりすることがあります。 ただし、変更する必要があるのはコアのみです [!DNL Adobe Commerce] 限られた状況でのテーブル（またはサードパーティのベンダーテーブル）。

## Adobeが変更を避けることを推奨する理由

コアテーブルを変更しない主な理由は、Adobe Commerceに生の SQL クエリを含む基礎となるロジックが含まれているからです。 テーブルの構造を変更すると、予期しない副作用が発生する可能性があり、トラブルシューティングが困難になる場合があります。 また、この変更は DDL （データ定義言語）操作に影響を与え、予期しない予期しないパフォーマンスへの影響を引き起こす可能性があります。

データベーステーブルの構造の変更を避けるもう 1 つの理由は、コア開発チームまたはサードパーティの開発者がデータベーステーブルの構造を変更した場合、変更によって問題が発生する可能性があることです。 例えば、という列を持つコアデータベーステーブルがいくつかあります `additional_data`. これは常に `text` 列タイプ。 ただし、パフォーマンス上の理由から、コアチームは列をに変更する場合があります `longtext`. このタイプの列は JSON のエイリアスです。 この列タイプに変換すると、パフォーマンスが向上し、その列に検索性が追加されますが、は存在しません。 `text` タイプ。 このトピックの詳細については、を参照してください。 [JSON データタイプ](https://mariadb.com/kb/en/json-data-type/){target="_blank"}.

## データを保存または削除するタイミングを把握する

Adobeでは、まずこのデータを保存する必要があるかどうかを判断することをお勧めします。 レガシーシステムからデータを移動する場合、削除できるデータがあれば、移行中の時間と労力を節約できます。 （後でアクセスする必要がある場合は、データをアーカイブする方法があります）。 アプリケーションとパフォーマンスを適切に管理するために、追加のデータを保存するリクエストに挑戦しても問題ありません。 目標は、別の方法では実現できないビジネスニーズを満たすために、データを保存することが要件であることを確認することです。

### レガシーデータ

古い注文や顧客レコードなどの従来のデータがプロジェクトに含まれている場合は、別の参照方法を検討してください。 例えば、ビジネスで、一時的な参照のためにデータへのアクセスのみを必要とする場合は、古いデータをに移行する代わりに、コマースプラットフォームの外部でホストされている古いデータベースの外部検索を実装することを検討します [!DNL Adobe Commerce].

この状況では、データベースをサーバーに移行し、データを読み取るための web インターフェイスを提供するか、MySQL Workbench または同様のツールの使用に関するトレーニングを提供する必要があります。 新しいデータベースからこのデータを除外すると、開発チームがデータ移行の問題のトラブルシューティングではなく新しいサイトに集中できるので、移行が迅速化されます。

データをコマースの外部に保持しても、リアルタイムで使用できるもう 1 つの関連するオプションは、GraphQL メッシュなどの他のツールを活用することです。 このオプションは、様々なデータソースを組み合わせ、単一の応答として返します。

例えば、 `stitch` 外部データベースからの古い注文（おそらく、廃止された古いMagento 1 サイト）をまとめたものです。 次に、GraphQL メッシュを使用して、顧客の注文履歴の一部として表示します。 これらの古い注文は、現在の注文と組み合わせることができます [!DNL Adobe Commerce] 環境。

GraphQLでの API メッシュの使用について詳しくは、を参照してください。 [API メッシュとは](https://developer.adobe.com/graphql-mesh-gateway/gateway/overview/){target="_blank"}) and [GraphQL Mesh Gateway](https://developer.adobe.com/graphql-mesh-gateway/){target="_blank"}.

## 拡張属性を持つ従来のデータの移行

レガシーデータの移行が必要であるか、新しいデータをに保存する必要があると判断した場合 [!DNL Adobe Commerce]、Adobeでは次を使用することをお勧めします [拡張属性](https://developer.adobe.com/commerce/php/development/components/add-attributes/){target="_blank"}. 拡張属性を使用して追加データを保存すると、次の利点があります。

- 永続化するデータおよびデータベース構造を制御できます。これにより、データが正しい列タイプおよび適切なインデックスで保存されます。
- 内のほとんどのエンティティ [!DNL Adobe Commerce] 拡張属性の使用をサポートします。
- 拡張属性は、ストレージに依存しないメカニズムで、プロジェクトに最適な場所にデータを柔軟に保存できます。

ストレージの場所の 2 つの例は、データベーステーブルと [!DNL Redis]. 場所を選択する際に考慮すべき重要な事項は、場所によって複雑さが増すか、パフォーマンスに影響を与えるかです。

### 他の選択肢を検討する

開発者は、の外部でツールを使用することを常に検討することが重要です [!DNL Adobe Commerce] 環境（GraphQL メッシュやAdobeApp Builder など）。 これらのツールは、データへのアクセスを保持するのに役立ちますが、コアコマースアプリケーションやその基礎となるデータベーステーブルには影響しません。 このアプローチでは、API を通じてデータを公開します。 次に、データソースを App Builder 設定に追加します。 GraphQL Mesh を使用すると、これらのデータソースを組み合わせて、に記載されているように 1 つの応答を生成できます。 [レガシーデータ](#legacy-data).

GraphQL メッシュの詳細については、を参照してください。 [GraphQL メッシュ ゲートウェイ](https://developer.adobe.com/graphql-mesh-gateway/){target="_blank"}. For information about the Adobe App Builder,  see [Introducing App Builder](https://experienceleague.adobe.com/docs/adobe-developers-live-events/events/2021/oct2021/introduction-app-builder.html?lang=en){target="_blank"}.

## コアテーブルまたはサードパーティのテーブルの変更

コアを変更してデータを保存する場合 [!DNL Adobe Commerce] またはサードパーティのモジュールデータベーステーブルの場合は、次のガイドラインを使用して、安定性とパフォーマンスに対する影響を最小限に抑えます。

- 新しい列のみを追加します。
- 決して変更しない _タイプ_ 既存の列の値 例えば、 `integer` から `varchar` お客様固有のユースケースを満たすために。
- EAV 属性テーブルには列を追加しないでください。 これらのテーブルには、ロジックと職責が既にオーバーロードされています。
- テーブルを調整する前に、そのサイズを決定します。 大きなテーブルを変更するとデプロイメントに影響を与えるため、変更が適用されたときに数分または数時間の遅延が発生する可能性があります。

## 外部データベーステーブルの変更に関するベストプラクティス

Adobeでは、コアデータベーステーブルまたはサードパーティのテーブルに列を追加する場合、次の手順に従うことをお勧めします。

1. 更新対象を表す名前を使用して、名前空間にモジュールを作成します。

   例： `app/code/YourCompany/Customer`

1. 適切なファイルを作成し、モジュールを有効にします（ [モジュールの作成](https://experienceleague.adobe.com/docs/commerce-learn/tutorials/backend-development/create-module.html){target="_blank"}.

1. というファイルを作成します。 `db_schema.xml` が含まれる `etc` フォルダーに移動し、適切な変更を行います。

   該当する場合、 `db_schema_whitelist.json` ファイル。 参照： [宣言スキーマ](https://developer.adobe.com/commerce/php/development/components/declarative-schema/configuration/){target="_blank"} を参照してください。

### 潜在的な影響

外部データベースへの列の追加は、次の点でAdobe Commerce プロジェクトに影響を与える可能性があります。

- アップグレードはより複雑になる場合があります。
- 変更するテーブルが大きい場合、デプロイメントは影響を受けます。
- 新しいプラットフォームへの移行はより複雑になる場合があります。

## コアテーブルの変更を回避する方法

を使用すると、Adobe Commerceのデータベーステーブルを変更するのを回避できます。 [拡張属性](#migrate-legacy-data-with-extension-attributes). 別の方法として、特別な列（`additional_data`）が、データを保存し、JSON エンコードされた形式で保存するためのいくつかのコアテーブルで見つかりました。

### JSON エンコードされたデータ列にデータを保存

一部のコアテーブルには `additional_data` json エンコードされたデータを格納する列。 この列は、1 つのフィールドに追加のデータをマッピングするネイティブな方法を提供します。 この方法を使用すると、検索を必要とせずに、データ検索用の情報を格納する小さな単純なデータ要素のテーブルを追加する必要がなくなります。 この `additional_data` 列は通常、品目レベルでのみ使用でき、見積もりや受注全体では使用できません。

- を使用する場合の利点 `additional_data` フィールド

   - 追加のフィールドは必要ないため、列の数が最小限に抑えられます。 これは、既に多くのテーブルが関係している販売フローで役立ちます。 既に複雑なプロセスに複雑さを加えないようにすることをお勧めします。 この方法は、多くのユースケースを満たしますが、すべてのユースケースを満たすわけではありません。

- デメリット

   - この方法は、読み取り専用データの保存にのみ最適です。 この問題は、依存関係またはデータベース関係を追加するために、オブジェクトを変更および作成するコードをシリアル化解除する必要があるために発生します。

   - データベース操作を使用してこれらのフィールドを検索するのは困難です。 この方法では検索が遅くなります。

   - にデータを保存する際は細心の注意を払う必要があります `additional_data` 列：無効な JSON が作成されたり、実行時に読み取りエラーが発生したりして、コードが破損する可能性があるシリアル化またはシリアル化解除の操作がトリガーされるのを回避します。

   - これらのフィールドは、開発者が簡単に見つけられるように、コードで明確に宣言する必要があります。

   - その他、診断が非常に困難な問題。 例えば、を使用しない場合、いくつかのネイティブの PHP 関数を使用します。 [!DNL Adobe Commerce] コアアプリケーションによって提供されるラッパーメソッド変換されたデータの最終結果は、期待される形式とは異なる場合があります。 保存または取得するデータの一貫性と予測可能性を確保するには、常にラッパー関数を使用します。

以下は、の列と構造を持つテーブルの例です `additional_data` 列。

```mysql
MariaDB [main]> DESCRIBE quote_item additional_data;
+-----------------+------+------+-----+---------+-------+
| Field           | Type | Null | Key | Default | Extra |
+-----------------+------+------+-----+---------+-------+
| additional_data | text | YES  |     | NULL    |       |
+-----------------+------+------+-----+---------+-------+
1 row in set (0.001 sec)


MariaDB [main]> DESCRIBE sales_order_item additional_data;
+-----------------+------+------+-----+---------+-------+
| Field           | Type | Null | Key | Default | Extra |
+-----------------+------+------+-----+---------+-------+
| additional_data | text | YES  |     | NULL    |       |
+-----------------+------+------+-----+---------+-------+
1 row in set (0.001 sec)
```

バージョン 2.4.3、2.4.4 および 2.4.5 では、 `additional_data`.

```mysql
MariaDB [magento]> SELECT DISTINCT TABLE_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME IN ('additional_data') AND TABLE_SCHEMA='main';
+------------------------+
| TABLE_NAME             |
+------------------------+
| sales_shipment_item    |
| sales_creditmemo_item  |
| sales_invoice_item     |
| catalog_eav_attribute  |
| sales_order_payment    |
| quote_address_item     |
| quote_payment          |
| quote_item             |
| magento_reward_history |
| sales_order_item       |
+------------------------+
10 rows in set (0.020 sec)
```
